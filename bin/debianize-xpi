#!/bin/sh

prog=${0##*/}
rev="1"

CURL_OPTIONS=""

MAINTAINER="$DEBFULLNAME${DEBUFULLNAME:- }<${DEBMAIL:-$USER@$(hostname -f)}>"

usage(){
	printf "$prog [-h] [ -r REVISION ] XPI_URL\n" >&2
	exit 1
}

error(){
	printf "$prog: $1\n" >&2
	exit 2
}

which fakeroot >/dev/null || error "fakeroot has to be installed."
which xmlstarlet >/dev/null || error "xmlstarlet has to be installed."

while getopts "hr:" opt;do
	case $opt in
		h) usage ;;
		r) rev=$OPTARG ;;
	esac
done

shift $(( $OPTIND - 1 ))
		

makedir() { [ -d "$1" ] || mkdir -p "$1"; }

normalize_package_name(){
	sed -e 's/_/-/g' | tr '[:upper:]' '[:lower:]'
}

rdf_get(){
	unzip -qq -c "$base_dir/foo.xpi" install.rdf |  xmlstarlet sel -N 'r=http://www.w3.org/1999/02/22-rdf-syntax-ns#' -t \
		-v 'substring-before(concat("version ",/r:RDF/r:Description/em:version),"-signed")' -n \
		-v 'concat("name ",/r:RDF/r:Description/em:name)' -n \
		-v 'concat("id ",/r:RDF/r:Description/em:id)' -n \
		-v 'concat("description ",/r:RDF/r:Description/em:localized/r:Description[ em:locale = "en-US"]/em:description)' \
	| while read var val;do
		printf "%s=%q\n" "$var" "$val"
	done
}


url=$1

base_dir=$(mktemp -d "/tmp/$prog-XXXXXXXX") || { printf "Error creating a temporary directory\n" >&2; exit 1; }

makedir "$base_dir"

curl -Lo "$base_dir/foo.xpi" $CURL_OPTIONS "$url" || error "Error while downloading"

eval $(rdf_get)

name=$(echo "$name" | normalize_package_name )

package_name="xul-ext-$name"

build_dir="$base_dir/$package_name-${version}-${rev}"

makedir "$build_dir/debian"

cat > $build_dir/debian/control <<-EOF
	Source: $package_name
	Section: web
	Priority: optional
	Maintainer: $MAINTAINER
	Build-Depends: debhelper

	Package: $package_name
	Section: web
	Architecture: all
	Depends: \${misc:Depends}, \${xpi:Depends}
	Recommends: \${xpi:Recommends},
	Provides: \${xpi:Provides}
	Enhances: \${xpi:Enhances}
	Breaks: \${xpi:Breaks}
	Description: XUL Extension $name
	 This extension was automatically created by dh-make-xpi.
	 .
	 $description

EOF

echo 9 > "$build_dir/debian/compat"

cat > "$build_dir/debian/copyright" <<-EOF
	This package was debianized by $MAINTAINER on
	$(date)

	It was downloaded from https://addons.mozilla.org
	
	Copyright is held by the upstream author.
EOF

cat > "$build_dir/debian/changelog" <<-EOF
	$package_name ($version-$rev) unstable; urgency=low

	  * Packaged by debianize-xpi

	 -- $MAINTAINER  $(LANG=C date -R)
EOF

cat > "$build_dir/debian/rules" <<'EOF'
#!/usr/bin/make -f
%:
	dh $@ --with xul-ext

override_dh_auto_install:
	install-xpi -x COPYING ../foo.xpi
EOF

( cd "$build_dir"; debuild -b -uc -us);

cp "$base_dir"/*.deb .

rm -R "$base_dir"

exit 0
