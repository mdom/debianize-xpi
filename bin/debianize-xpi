#!/bin/sh

prog=${0##*/}
rev="1"

CURL_OPTIONS=""
MAINTAINER="Mario Domgoergen <dom@math.uni-bonn.de>"

usage(){
	printf "dh-make-xpi [-h] [-m MAINTAINER] [ -r REVISION ] XPI_URL\n" >&2
	exit 1
}

error(){
	printf "$prog: $1\n" >&2
	exit 2
}

which fakeroot >/dev/null || error "fakeroot has to be installed."
which xmlstarlet >/dev/null || error "xmlstarlet has to be installed."

while getopts "m:hr:" opt;do
	case $opt in
		m) MAINTAINER=$OPTARG ;;
		h) usage ;;
		r) rev=$OPTARG ;;
	esac
done

shift $(( $OPTIND - 1 ))
		

makedir() { [ -d "$1" ] || mkdir -p "$1"; }

normalize_package_name(){
	sed -e 's/_/-/g' | tr '[:upper:]' '[:lower:]'
}

rdf_get(){
	unzip -qq -c "$base_dir/foo.xpi" install.rdf |  xmlstarlet sel -N 'r=http://www.w3.org/1999/02/22-rdf-syntax-ns#' -t \
		-v 'substring-before(concat("version ",/r:RDF/r:Description/em:version),"-signed")' -n \
		-v 'concat("name ",/r:RDF/r:Description/em:name)' -n \
		-v 'concat("id ",/r:RDF/r:Description/em:id)' -n \
		-v 'concat("description ",/r:RDF/r:Description/em:localized/r:Description[ em:locale = "en-US"]/em:description)' \
	| while read var val;do
		printf "%s=%q\n" "$var" "$val"
	done
}


url=$1

base_dir=$(mktemp -d "/tmp/$prog-XXXXXXXX") || { printf "Error creating a temporary directory\n" >&2; exit 1; }

case $url in
	*/thunderbird/* ) 
		programm=icedove
		;;
	*/firefox/* ) 
		programm=iceweasel
		browser=browser/
		;;
esac

makedir "$base_dir"

curl -Lo "$base_dir/foo.xpi" $CURL_OPTIONS "$url" || error "Error while downloading"

eval $(rdf_get)

name=$(echo "$name" | normalize_package_name )

build_dir="$base_dir/${programm}-${name}-${version}-${rev}_all"

package_name="$programm-$name"

makedir "$build_dir/DEBIAN"

extension_dir="$build_dir/usr/lib/$programm/${browser}extensions/$id"
makedir "$extension_dir"

doc_dir="$build_dir/usr/share/doc/$package_name/"
makedir "$doc_dir"

cat > $build_dir/DEBIAN/control <<-EOF
	Package: $package_name
	Version: $version-$rev
	Section: web
	Priority: optional
	Architecture: all
	Maintainer: $MAINTAINER
	Depends: $programm
	Description: Extension $name for $programm
	 This extension was automatically created by dh-make-xpi.
	 .
	 $description
EOF

cat > "$doc_dir/copyright" <<-EOF
	This package was debianized by $MAINTAINER on
	$(date)

	It was downloaded from https://addons.mozilla.org
	
	Copyright is held by the upstream author.
EOF

cp -r "$base_dir"/tmp/src/* "$extension_dir"
find "$build_dir" -type d -print0 | xargs -0r chmod 755
find "$build_dir" -type f -print0 | xargs -0r chmod 644
fakeroot dpkg-deb --build "$build_dir"
cp "$base_dir"/*.deb .

rm -R "$base_dir"

exit 0
